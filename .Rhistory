dnorm(seq(-0.2, 0.4, length=1000), 0.2, 0.1)
)
plot(
seq(-0.2, 0.4, length=1000),
dnorm(seq(-0.2, 0.4, length=1000), 0.3, 0.1)
)
plot(
seq(-0.2, 0.6, length=1000),
dnorm(seq(-0.2, 0.6, length=1000), 0.3, 0.1)
)
plot(
seq(-0.2, 0.6, length=1000),
dnorm(seq(-0.2, 0.6, length=1000), 0.25, 0.1)
)
set_inits <- function(seed = 1) {
set.seed(seed)
list(
b = rnorm(n = 1, mean = 0.3, sd = 0.1),
sd = runif(n = 1, min = 0, max = 1)
)
}
list_of_inits <- list(
# different seed values will return different results
set_inits(seed = 1),
set_inits(seed = 2),
set_inits(seed = 3),
set_inits(seed = 4)
)
list_of_inits
# Model w prior
main_model_w_prior <-
brm(
yi | se(sqrt(vi)) ~ 0 + Intercept + mean_muscle_length_centred * site_centred +
(mean_muscle_length_centred + site_centred | study_number) +
(1 | arm_number) +
(1 | effect_number),
data = data,
prior = main_model_prior,
chains = 4,
cores = 4,
seed = 1988,
warmup = 2000,
iter = 8000,
init = list_of_inits,
control = list(adapt_delta = 0.99)
)
set_inits <- function(seed = 1) {
set.seed(seed)
list(
beta = rnorm(n = 1, mean = 0.3, sd = 0.1),
sd = runif(n = 1, min = 0, max = 1)
)
}
list_of_inits <- list(
# different seed values will return different results
set_inits(seed = 1),
set_inits(seed = 2),
set_inits(seed = 3),
set_inits(seed = 4)
)
# Model w prior
main_model_w_prior <-
brm(
yi | se(sqrt(vi)) ~ 0 + Intercept + mean_muscle_length_centred * site_centred +
(mean_muscle_length_centred + site_centred | study_number) +
(1 | arm_number) +
(1 | effect_number),
data = data,
prior = main_model_prior,
chains = 4,
cores = 4,
seed = 1988,
warmup = 2000,
iter = 8000,
init = list_of_inits,
control = list(adapt_delta = 0.99)
)
plot(main_model_w_prior)
# Interaction plot - slopes
slopes <- avg_slopes(
main_model_w_prior,
variables = "mean_muscle_length_centred",
newdata = datagrid(
mean_muscle_length_centred = seq(-35, 35, length = 101),
site_centred = c(-25,0,25),
vi = 0
),
by = "site_centred"
) |>
posterior_draws()
rope_percents <- tibble(
site_centred = c(-25,0,25),
rope_percent = c(
bayestestR::rope(filter(slopes, site_centred == -25)$draw*50, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 0)$draw*50, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 25)$draw*50, range = c(-0.1, 0.1))$ROPE_Percentage
)
)
summary <- avg_slopes(
model,
variables = "mean_muscle_length_centred",
newdata = datagrid(
mean_muscle_length_centred = seq(-35, 35, length = 101),
site_centred = c(-25,0,25),
vi = 0
),
by = "site_centred"
)
slopes |>
ggplot(aes(x = site_centred+50, y = draw*50)) +
geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.75) +
geom_hline(yintercept = c(-0.1,0.1), linetype = "dashed") +
stat_slabinterval(aes(fill = site_centred+50), alpha = 0.75) +
annotate("text", summary$site_centred+45, summary$estimate*50, label = round(summary$estimate*50,2), size = 3) +
annotate("text", summary$site_centred+45, summary$conf.low*50, label = round(summary$conf.low*50,2), size = 3) +
annotate("text", summary$site_centred+45, summary$conf.high*50, label = round(summary$conf.high*50,2), size = 3) +
annotate("rect", xmin = 12.5, xmax = 87.5, ymin = 0.825, ymax = 1.125, color = "black", fill = "white") +
annotate("text", rope_percents$site_centred+50, 0.9, label = glue::glue("{round(rope_percents$rope_percent*100,2)}%"), size = 3) +
annotate("text", x=50, y=1.05, label="Percentage of Posterior Distibution within ROPE [-0.1,0.1]", size = 3) +
scale_fill_viridis_c() +
scale_x_continuous(breaks = c(0,25,50,75,100), limits = c(0,100)) +
scale_y_continuous(breaks = c(-1,-0.75,-0.5,-0.25,0,0.25,0.5,0.75,1)) +
guides(
color = "none"
) +
labs(
x = "Site of Measurement (%)",
y = "Slope for Muscle Length",
fill = "Site of Measurement (%)"
) +
theme_classic() +
theme(panel.border = element_rect(fill = NA),
axis.title = element_text(size=10))
rope_percents
# Interaction plot - slopes
slopes <- avg_slopes(
main_model_w_prior,
variables = "mean_muscle_length_centred",
newdata = datagrid(
mean_muscle_length_centred = seq(-0.35, 0.35, length = 101),
site_centred = c(-0.25,0,0.25),
vi = 0
),
by = "site_centred"
) |>
posterior_draws()
rope_percents <- tibble(
site_centred = c(-0.25,0,0.25),
rope_percent = c(
bayestestR::rope(filter(slopes, site_centred == -25)$draw*50, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 0)$draw*50, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 25)$draw*50, range = c(-0.1, 0.1))$ROPE_Percentage
)
)
rope_percents <- tibble(
site_centred = c(-0.25,0,0.25),
rope_percent = c(
bayestestR::rope(filter(slopes, site_centred == -25)$draw/2, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 0)$draw/2, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 25)$draw/2, range = c(-0.1, 0.1))$ROPE_Percentage
)
)
rope_percents
rope_percents <- tibble(
site_centred = c(-0.25,0,0.25),
rope_percent = c(
bayestestR::rope(filter(slopes, site_centred == -0.25)$draw/2, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 0)$draw/2, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 0.25)$draw/2, range = c(-0.1, 0.1))$ROPE_Percentage
)
)
rope_percents
summary <- avg_slopes(
model,
variables = "mean_muscle_length_centred",
newdata = datagrid(
mean_muscle_length_centred = seq(-0.35, 0.35, length = 101),
site_centred = c(-0.25,0,0.25),
vi = 0
),
by = "site_centred"
)
summary <- avg_slopes(
main_model_w_prior,
variables = "mean_muscle_length_centred",
newdata = datagrid(
mean_muscle_length_centred = seq(-0.35, 0.35, length = 101),
site_centred = c(-0.25,0,0.25),
vi = 0
),
by = "site_centred"
)
slopes |>
ggplot(aes(x = (site_centred*100)+50, y = draw/2)) +
geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.75) +
geom_hline(yintercept = c(-0.1,0.1), linetype = "dashed") +
stat_slabinterval(aes(fill = site_centred+50), alpha = 0.75) +
annotate("text", (summary$site_centred*100)+45, summary$estimate/2, label = round(summary$estimate/2,2), size = 3) +
annotate("text", (summary$site_centred*100)+45, summary$conf.low/2, label = round(summary$conf.low/2,2), size = 3) +
annotate("text", (summary$site_centred*100)+45, summary$conf.high/2, label = round(summary$conf.high/2,2), size = 3) +
annotate("rect", xmin = 12.5, xmax = 87.5, ymin = 0.825, ymax = 1.125, color = "black", fill = "white") +
annotate("text", (rope_percents$site_centred*100)+50, 0.9, label = glue::glue("{round(rope_percents$rope_percent*100,2)}%"), size = 3) +
annotate("text", x=50, y=1.05, label="Percentage of Posterior Distibution within ROPE [-0.1,0.1]", size = 3) +
scale_fill_viridis_c() +
scale_x_continuous(breaks = c(0,25,50,75,100), limits = c(0,100)) +
scale_y_continuous(breaks = c(-1,-0.75,-0.5,-0.25,0,0.25,0.5,0.75,1)) +
guides(
color = "none"
) +
labs(
x = "Site of Measurement (%)",
y = "Slope for Muscle Length",
fill = "Site of Measurement (%)"
) +
theme_classic() +
theme(panel.border = element_rect(fill = NA),
axis.title = element_text(size=10))
# Interaction plot
preds <- crossing(
mean_muscle_length_centred = seq(-0.35, 0.35, length = 101),
site_centred = c(-0.25,0,0.25),
vi = 0
) |>
add_epred_draws(main_model_w_prior, re_formula = NA)
summary <- preds |>
group_by(mean_muscle_length_centred, site_centred) |>
mean_qi()
summary |>
ggplot(aes(x = (mean_muscle_length_centred*100)+50, y = .epred)) +
geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.75) +
geom_ribbon(aes(ymin = .epred.lower, ymax = .epred.upper,
group = as.factor((site_centred*100)+50), fill = (site_centred*100)+50),
alpha = 0.5, color = "black", size = 0.25) +
geom_line(aes(y = .epred,
group = as.factor((site_centred*100)+50)), size = 1, color = "black") +
geom_line(aes(y = .epred,
group = as.factor((site_centred*100)+50), color = (site_centred*100)+50)) +
geom_point(data = data,
aes(y = yi, size = size + 0.25), color = "black", fill = NA, shape = 21, alpha = 0.5) +
geom_point(data = data,
aes(y = yi, size = size, color = (site_centred*100)+50), alpha = 0.5) +
scale_color_viridis_c() +
scale_fill_viridis_c() +
scale_x_continuous(breaks = c(0,25,50,75,100)) +
scale_y_continuous(breaks = c(0,0.5,1,1.5,2,2.5)) +
guides(
size = "none",
color = "none"
) +
labs(
x = "Mean Muscle Length",
y = "Standardised Mean Change",
fill = "Site of Measurement",
title = "Interaction between mean muscle length and site of measurement",
subtitle = "Global grand mean and 95% quantile intervals presented for predictions at 25%, 50%, and 75% of centred site of measurement"
) +
theme_classic() +
theme(panel.border = element_rect(fill = NA),
legend.position = "bottom",
plot.subtitle = element_text(size=8))
main_model_w_prior
main_model_w_prior_only <-
brm(yi | se(sqrt(vi)) ~ 0 + Intercept + mean_muscle_length_centred * site_centred +
(mean_muscle_length_centred + site_centred | study_number) +
(1 | arm_number) +
(1 | effect_number),
data = data,
prior = main_model_prior,
chains = 4,
cores = 4,
seed = 1988,
warmup = 2000,
iter = 8000,
control = list(adapt_delta = 0.99),
sample_prior = "only"
)
pp_check(main_model_w_prior_only)
main_model_w_prior_only |>
gather_draws()
get_variables(main_model_w_prior_only)
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`)
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
ggplot(aes(x=.value)) +
geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.75) +
stat_slab(alpha = 0.75) +
facet_wrap(".variable")
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
ggplot(aes(x=.value)) +
geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.75) +
stat_slab(alpha = 0.75) +
facet_wrap(".variable") +
scale_x_continuous(limits = c(-0.1,0.4), breaks = seq(-0.5,0.5, length = 11))
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
mutate(.value = case_when(
.variable == "b_mean_muscle_length_centred" ~ .value/2
)) |>
ggplot(aes(x=.value)) +
geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.75) +
stat_slab(alpha = 0.75) +
facet_wrap(".variable") +
scale_x_continuous(limits = c(-0.1,0.4), breaks = seq(-0.5,0.5, length = 11))
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
mutate(.value = case_when(
.variable == "b_mean_muscle_length_centred" ~ .value/2,
.variable == "b_site_centred" ~ .value/2,
.variable == "b_mean_muscle_length_centred:site_centred" ~ .value/2
)) |>
ggplot(aes(x=.value)) +
geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.75) +
stat_slab(alpha = 0.75) +
facet_wrap(".variable") +
scale_x_continuous(limits = c(-0.1,0.4), breaks = seq(-0.5,0.5, length = 11))
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
mutate(.value = case_when(
.variable == "b_mean_muscle_length_centred" ~ .value/2,
.variable == "b_site_centred" ~ .value/2,
.variable == "b_mean_muscle_length_centred:site_centred" ~ .value/2
.variable == "b_Intercept" ~ .value
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
mutate(.value = case_when(
.variable == "b_mean_muscle_length_centred" ~ .value/2,
.variable == "b_site_centred" ~ .value/2,
.variable == "b_mean_muscle_length_centred:site_centred" ~ .value/2,
.variable == "b_Intercept" ~ .value
)) |>
ggplot(aes(x=.value)) +
geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.75) +
stat_slab(alpha = 0.75) +
facet_wrap(".variable") +
scale_x_continuous(limits = c(-0.1,0.4), breaks = seq(-0.5,0.5, length = 11))
# Interaction plot - slopes
slopes <- avg_slopes(
main_model_w_prior,
variables = "mean_muscle_length_centred",
newdata = datagrid(
mean_muscle_length_centred = seq(-0.35, 0.35, length = 101),
site_centred = c(-0.25,0,0.25),
vi = 0
),
by = "site_centred"
) |>
posterior_draws()
rope_percents <- tibble(
site_centred = c(-0.25,0,0.25),
rope_percent = c(
bayestestR::rope(filter(slopes, site_centred == -0.25)$draw/2, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 0)$draw/2, range = c(-0.1, 0.1))$ROPE_Percentage,
bayestestR::rope(filter(slopes, site_centred == 0.25)$draw/2, range = c(-0.1, 0.1))$ROPE_Percentage
)
)
rope_percents
summary <- avg_slopes(
main_model_w_prior,
variables = "mean_muscle_length_centred",
newdata = datagrid(
mean_muscle_length_centred = seq(-0.35, 0.35, length = 101),
site_centred = c(-0.25,0,0.25),
vi = 0
),
by = "site_centred"
)
summary
slopes
slopes |>
ggplot(aes(x = (site_centred*100)+50, y = draw/2)) +
geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.75) +
geom_hline(yintercept = c(-0.1,0.1), linetype = "dashed") +
stat_slabinterval(aes(fill = site_centred+50), alpha = 0.75) +
annotate("text", (summary$site_centred*100)+45, summary$estimate/2, label = round(summary$estimate/2,2), size = 3) +
annotate("text", (summary$site_centred*100)+45, summary$conf.low/2, label = round(summary$conf.low/2,2), size = 3) +
annotate("text", (summary$site_centred*100)+45, summary$conf.high/2, label = round(summary$conf.high/2,2), size = 3) +
annotate("rect", xmin = 12.5, xmax = 87.5, ymin = 0.825, ymax = 1.125, color = "black", fill = "white") +
annotate("text", (rope_percents$site_centred*100)+50, 0.9, label = glue::glue("{round(rope_percents$rope_percent*100,2)}%"), size = 3) +
annotate("text", x=50, y=1.05, label="Percentage of Posterior Distibution within ROPE [-0.1,0.1]", size = 3) +
scale_fill_viridis_c() +
scale_x_continuous(breaks = c(0,25,50,75,100), limits = c(0,100)) +
scale_y_continuous(breaks = c(-1,-0.75,-0.5,-0.25,0,0.25,0.5,0.75,1)) +
guides(
color = "none"
) +
labs(
x = "Site of Measurement (%)",
y = "Slope for Muscle Length",
fill = "Site of Measurement (%)"
) +
theme_classic() +
theme(panel.border = element_rect(fill = NA),
axis.title = element_text(size=10))
slopes |>
ggplot(aes(x = (site_centred*100)+50, y = draw/2)) +
geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.75) +
geom_hline(yintercept = c(-0.1,0.1), linetype = "dashed") +
stat_slabinterval(aes(fill = (site_centred*100)+50), alpha = 0.75) +
annotate("text", (summary$site_centred*100)+45, summary$estimate/2, label = round(summary$estimate/2,2), size = 3) +
annotate("text", (summary$site_centred*100)+45, summary$conf.low/2, label = round(summary$conf.low/2,2), size = 3) +
annotate("text", (summary$site_centred*100)+45, summary$conf.high/2, label = round(summary$conf.high/2,2), size = 3) +
annotate("rect", xmin = 12.5, xmax = 87.5, ymin = 0.825, ymax = 1.125, color = "black", fill = "white") +
annotate("text", (rope_percents$site_centred*100)+50, 0.9, label = glue::glue("{round(rope_percents$rope_percent*100,2)}%"), size = 3) +
annotate("text", x=50, y=1.05, label="Percentage of Posterior Distibution within ROPE [-0.1,0.1]", size = 3) +
scale_fill_viridis_c() +
scale_x_continuous(breaks = c(0,25,50,75,100), limits = c(0,100)) +
scale_y_continuous(breaks = c(-1,-0.75,-0.5,-0.25,0,0.25,0.5,0.75,1)) +
guides(
color = "none"
) +
labs(
x = "Site of Measurement (%)",
y = "Slope for Muscle Length",
fill = "Site of Measurement (%)"
) +
theme_classic() +
theme(panel.border = element_rect(fill = NA),
axis.title = element_text(size=10))
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
mutate(.value = case_when(
.variable == "b_mean_muscle_length_centred" ~ .value/2,
.variable == "b_site_centred" ~ .value/2,
.variable == "b_mean_muscle_length_centred:site_centred" ~ .value/2,
.variable == "b_Intercept" ~ .value
)) |>
ggplot(aes(x=.value)) +
geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.75) +
stat_slab(alpha = 0.75) +
facet_wrap(".variable") +
scale_x_continuous(limits = c(-0.1,0.4), breaks = seq(-0.5,0.5, length = 11)) +
labs(
x = "Model Coefficients",
y = "Density",
title = "Prior distribution for fixed (i.e., population level) effects"
) +
theme_classic() +
theme(panel.border = element_rect(fill = NA))
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
mutate(.value = case_when(
.variable == "b_mean_muscle_length_centred" ~ .value/2,
.variable == "b_site_centred" ~ .value/2,
.variable == "b_mean_muscle_length_centred:site_centred" ~ .value/2,
.variable == "b_Intercept" ~ .value
)) |>
ggplot(aes(x=.value)) +
geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.75) +
stat_slab(alpha = 0.75) +
facet_wrap(".variable") +
scale_x_continuous(limits = c(-0.1,0.4), breaks = seq(-0.5,0.5, length = 11)) +
labs(
x = "Model Coefficients",
y = "Density",
title = "Prior distribution for fixed (i.e., population level) effects",
subtitle = "Note, with the exception of the Intercept, coefficients have been halved to reflect a typical short vs long length/site difference of 50%"
) +
theme_classic() +
theme(panel.border = element_rect(fill = NA))
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
mutate(.value = case_when(
.variable == "b_mean_muscle_length_centred" ~ .value/2,
.variable == "b_site_centred" ~ .value/2,
.variable == "b_mean_muscle_length_centred:site_centred" ~ .value/2,
.variable == "b_Intercept" ~ .value
)) |>
ggplot(aes(x=.value)) +
geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.75) +
stat_slab(alpha = 0.75) +
facet_wrap(".variable") +
scale_x_continuous(limits = c(-0.1,0.4), breaks = seq(-0.5,0.5, length = 11)) +
labs(
x = "Model Coefficients",
y = "Density",
title = "Prior distribution for fixed (i.e., population level) effects",
subtitle = "Note, with the exception of the Intercept, coefficients have been halved to reflect a typical short vs long length/site difference of 50%"
) +
theme_classic() +
theme(panel.border = element_rect(fill = NA),
plot.subtitle = element_text(size = 10))
main_model_w_prior_only |>
gather_draws(b_Intercept, b_mean_muscle_length_centred, b_site_centred, `b_mean_muscle_length_centred:site_centred`) |>
mutate(.value = case_when(
.variable == "b_mean_muscle_length_centred" ~ .value/2,
.variable == "b_site_centred" ~ .value/2,
.variable == "b_mean_muscle_length_centred:site_centred" ~ .value/2,
.variable == "b_Intercept" ~ .value
)) |>
ggplot(aes(x=.value)) +
geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.75) +
stat_slab(alpha = 0.75) +
facet_wrap(".variable") +
scale_x_continuous(limits = c(-0.1,0.4), breaks = seq(-0.5,0.5, length = 11)) +
labs(
x = "Model Coefficients",
y = "Density",
title = "Prior distribution for fixed (i.e., population level) effects",
subtitle = "Note, with the exception of the Intercept, coefficients have been halved to reflect a typical short vs long length/site difference of 50%"
) +
theme_classic() +
theme(panel.border = element_rect(fill = NA),
plot.subtitle = element_text(size = 8))
targets::tar_visnetwork()
targets::tar_make()
targets::tar_visnetwork()
targets::tar_make()
targets::tar_make()
targets::tar_make()
targets::tar_make()
